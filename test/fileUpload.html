<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suiknit API 测试平台</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .chunk-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .file-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 4px 4px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            margin: 0;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #007bff;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background-color: white;
        }
        .tabcontent.active {
            display: block;
        }
        .user-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .permission-select {
            width: auto;
            display: inline-block;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h1>Suiknit API 测试平台</h1>
    
    <div class="user-info" id="userInfo" style="display: none;">
        <strong>当前用户:</strong> <span id="currentUserName"></span> 
        (<span id="currentUserId"></span>)
        <button class="btn-danger" id="logoutBtn" style="float: right;">退出登录</button>
    </div>
    
    <div class="container">
        <div class="panel">
            <div class="tab">
                <button class="tablinks active" onclick="openTab(event, 'auth')">认证管理</button>
                <button class="tablinks" onclick="openTab(event, 'upload')">文件上传</button>
                <button class="tablinks" onclick="openTab(event, 'files')">文件管理</button>
                <button class="tablinks" onclick="openTab(event, 'download')">文件下载</button>
            </div>
            
            <!-- 认证管理 -->
            <div id="auth" class="tabcontent active">
                <h2>用户认证</h2>
                
                <!-- 注册 -->
                <div class="form-group">
                    <h3>用户注册</h3>
                    <div class="form-group">
                        <label for="regEmail">邮箱:</label>
                        <input type="email" id="regEmail" placeholder="请输入邮箱">
                    </div>
                    <div class="form-group">
                        <label for="regPassword">密码:</label>
                        <input type="password" id="regPassword" placeholder="请输入密码">
                    </div>
                    <div class="form-group">
                        <label for="regName">姓名:</label>
                        <input type="text" id="regName" placeholder="请输入姓名">
                    </div>
                    <div class="form-group">
                        <label for="regCaptchaCode">验证码:</label>
                        <input type="text" id="regCaptchaCode" placeholder="请输入图像验证码">
                    </div>
                    <div class="form-group">
                        <label for="regEmailCode">邮箱验证码:</label>
                        <input type="text" id="regEmailCode" placeholder="请输入邮箱验证码">
                    </div>
                    <button id="getCaptchaBtn">获取验证码</button>
                    <button id="getEmailCodeBtn">获取邮箱验证码</button>
                    <button id="registerBtn">注册</button>
                </div>
                
                <!-- 登录 -->
                <div class="form-group">
                    <h3>用户登录</h3>
                    <div class="form-group">
                        <label for="loginEmail">邮箱:</label>
                        <input type="email" id="loginEmail" placeholder="请输入邮箱">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">密码:</label>
                        <input type="password" id="loginPassword" placeholder="请输入密码">
                    </div>
                    <div class="form-group">
                        <label for="loginCaptchaCode">验证码:</label>
                        <input type="text" id="loginCaptchaCode" placeholder="请输入图像验证码">
                    </div>
                    <div class="form-group">
                        <label for="loginEmailCode">邮箱验证码 (可选):</label>
                        <input type="text" id="loginEmailCode" placeholder="邮箱验证码登录">
                    </div>
                    <button id="getLoginCaptchaBtn">获取验证码</button>
                    <button id="getLoginEmailCodeBtn">获取登录邮箱验证码</button>
                    <button id="loginBtn">登录</button>
                </div>
                
                <!-- 验证Token -->
                <div class="form-group">
                    <h3>Token验证</h3>
                    <button id="verifyTokenBtn">验证当前Token</button>
                </div>
            </div>
            
            <!-- 文件上传 -->
            <div id="upload" class="tabcontent">
                <h2>文件上传</h2>
                <div class="form-group">
                    <label for="fileInput">选择文件:</label>
                    <input type="file" id="fileInput" multiple>
                </div>
                
                <div class="form-group">
                    <label for="uploadChunkSize">分片大小 (MB):</label>
                    <select id="uploadChunkSize">
                        <option value="1">1 MB</option>
                        <option value="2" selected>2 MB</option>
                        <option value="5">5 MB</option>
                        <option value="10">10 MB</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fileDescription">文件描述:</label>
                    <textarea id="fileDescription" placeholder="请输入文件描述"></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isPublic" checked> 公共文件
                    </label>
                </div>
                
                <button id="uploadBtn">开始上传</button>
                <button id="cancelUploadBtn" disabled>取消上传</button>
                
                <div id="uploadProgressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="uploadProgressFill"></div>
                    </div>
                    <div id="uploadProgressText">0%</div>
                    <div class="chunk-info" id="uploadChunkInfo"></div>
                </div>
                
                <div id="uploadStatusContainer"></div>
                <div id="uploadFileInfoContainer"></div>
            </div>
            
            <!-- 文件管理 -->
            <div id="files" class="tabcontent">
                <h2>文件管理</h2>
                <button id="refreshFilesBtn">刷新文件列表</button>
                
                <div class="form-group">
                    <label for="filePermissionUserId">用户ID:</label>
                    <input type="text" id="filePermissionUserId" placeholder="请输入用户ID">
                </div>
                
                <div id="fileList" class="file-list">
                    <p>请先登录并刷新文件列表</p>
                </div>
            </div>
            
            <!-- 文件下载 -->
            <div id="download" class="tabcontent">
                <h2>文件下载</h2>
                <div class="form-group">
                    <label for="downloadFileId">文件ID:</label>
                    <input type="text" id="downloadFileId" placeholder="请输入文件ID">
                </div>
                <button id="downloadByIdBtn">下载文件</button>
                <div id="downloadStatusContainer"></div>
            </div>
        </div>
        
        <div class="panel">
            <h2>系统配置</h2>
            <div class="form-group">
                <label for="serverUrl">服务器地址:</label>
                <input type="text" id="serverUrl" value="http://localhost:3000" placeholder="请输入服务器地址">
            </div>
            
            <div class="form-group">
                <label for="apiVersion">API版本:</label>
                <select id="apiVersion">
                    <option value="v1">v1</option>
                    <option value="v2">v2</option>
                    <option value="dev">dev</option>

                </select>
            </div>
            
            <div class="form-group">
                <label for="authToken">认证Token:</label>
                <input type="text" id="authToken" placeholder="请输入JWT Token">
            </div>
            
            <h2>状态信息</h2>
            <div id="globalStatusContainer"></div>
            
            <h2>验证码图像</h2>
            <div id="captchaImageContainer"></div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        let currentCaptchaId = null;
        let abortController = null;
        let isUploading = false;
        let uploadedFiles = [];
        
        // 显示全局状态信息
        function showGlobalStatus(message, type = 'info') {
            const statusContainer = document.getElementById('globalStatusContainer');
            statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // 显示特定区域状态信息
        function showStatus(containerId, message, type = 'info') {
            const statusContainer = document.getElementById(containerId);
            statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // 更新上传进度
        function updateUploadProgress(percentage, chunkInfo = '') {
            const progressFill = document.getElementById('uploadProgressFill');
            const progressText = document.getElementById('uploadProgressText');
            const chunkInfoEl = document.getElementById('uploadChunkInfo');
            
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${Math.round(percentage)}%`;
            if (chunkInfo) {
                chunkInfoEl.textContent = chunkInfo;
            }
        }
        
        // 显示文件信息
        function showFileInfo(files) {
            const fileInfoContainer = document.getElementById('uploadFileInfoContainer');
            let html = '<h3>待上传文件:</h3>';
            
            files.forEach((file, index) => {
                html += `
                    <div class="file-info">
                        <strong>文件 ${index + 1}:</strong> ${file.name}<br>
                        <strong>大小:</strong> ${(file.size / (1024 * 1024)).toFixed(2)} MB<br>
                        <strong>类型:</strong> ${file.type || '未知'}
                    </div>
                `;
            });
            
            fileInfoContainer.innerHTML = html;
        }
        
        // 标签页切换
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }
        
        // 获取服务器URL和API版本
        function getServerUrl() {
            return document.getElementById('serverUrl').value;
        }
        
        function getApiVersion() {
            return document.getElementById('apiVersion').value;
        }
        
        function getApiBaseUrl() {
            return `${getServerUrl()}/${getApiVersion()}`;
        }
        
        // 获取认证Token
        function getAuthToken() {
            return document.getElementById('authToken').value || (currentUser ? currentUser.token : null);
        }
        
        // 设置认证Token
        function setAuthToken(token) {
            document.getElementById('authToken').value = token;
        }
        
        // 更新用户信息显示
        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                document.getElementById('currentUserName').textContent = currentUser.user.name;
                document.getElementById('currentUserId').textContent = currentUser.user.id;
                userInfo.style.display = 'block';
            } else {
                userInfo.style.display = 'none';
            }
        }
        
        // 获取验证码
        async function getCaptcha() {
            try {
                const response = await fetch(`${getApiBaseUrl()}/auth/captcha`);
                const data = await response.json();
                
                if (data.code === 200) {
                    currentCaptchaId = data.data.captchaId;
                    
                    // 显示验证码图像
                    const imgContainer = document.getElementById('captchaImageContainer');
                    imgContainer.innerHTML = `
                        <img src="${data.data.captchaImage}" alt="验证码" style="height: 40px;">
                        <p>验证码ID: ${data.data.captchaId}</p>
                    `;
                    
                    showGlobalStatus('验证码获取成功', 'success');
                } else {
                    showGlobalStatus(`获取验证码失败: ${data.message}`, 'error');
                }
            } catch (error) {
                showGlobalStatus(`获取验证码错误: ${error.message}`, 'error');
            }
        }
        
        // 获取邮箱验证码
        async function getEmailCode(email, type) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/auth/sendEmailCode`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        type: type
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    showGlobalStatus('邮箱验证码发送成功', 'success');
                } else {
                    showGlobalStatus(`发送邮箱验证码失败: ${data.message}`, 'error');
                }
            } catch (error) {
                showGlobalStatus(`发送邮箱验证码错误: ${error.message}`, 'error');
            }
        }
        
        // 用户注册
        async function register() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            const captchaCode = document.getElementById('regCaptchaCode').value;
            const emailCode = document.getElementById('regEmailCode').value;
            
            if (!email || !password || !name || !currentCaptchaId || !captchaCode || !emailCode) {
                showStatus('globalStatusContainer', '请填写所有注册信息', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        name: name,
                        captchaId: currentCaptchaId,
                        captchaCode: captchaCode,
                        emailCode: emailCode
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 201) {
                    currentUser = data.data;
                    setAuthToken(data.data.token);
                    updateUserInfo();
                    showStatus('globalStatusContainer', '注册成功', 'success');
                } else {
                    showStatus('globalStatusContainer', `注册失败: ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('globalStatusContainer', `注册错误: ${error.message}`, 'error');
            }
        }
        
        // 用户登录
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const captchaCode = document.getElementById('loginCaptchaCode').value;
            const emailCode = document.getElementById('loginEmailCode').value;
            
            if (!email) {
                showStatus('globalStatusContainer', '请输入邮箱', 'error');
                return;
            }
            
            // 确定登录方式
            const isPasswordLogin = !!(password && currentCaptchaId && captchaCode);
            const isEmailCodeLogin = !!emailCode;
            
            if (!isPasswordLogin && !isEmailCodeLogin) {
                showStatus('globalStatusContainer', '请选择登录方式：密码登录需要密码和图像验证码，邮箱验证码登录需要邮箱验证码', 'error');
                return;
            }
            
            try {
                const requestData = {
                    email: email
                };
                
                if (isPasswordLogin) {
                    requestData.password = password;
                    requestData.captchaId = currentCaptchaId;
                    requestData.captchaCode = captchaCode;
                }
                
                if (isEmailCodeLogin) {
                    requestData.emailCode = emailCode;
                }
                
                const response = await fetch(`${getApiBaseUrl()}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    currentUser = data.data;
                    setAuthToken(data.data.token);
                    updateUserInfo();
                    showStatus('globalStatusContainer', '登录成功', 'success');
                } else {
                    showStatus('globalStatusContainer', `登录失败: ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('globalStatusContainer', `登录错误: ${error.message}`, 'error');
            }
        }
        
        // 验证Token
        async function verifyToken() {
            const token = getAuthToken();
            
            if (!token) {
                showStatus('globalStatusContainer', '请先登录或输入Token', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/auth/loginByToken`, {
                    headers: {
                        'token': token
                    }
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    currentUser = data.data;
                    updateUserInfo();
                    showStatus('globalStatusContainer', 'Token验证成功', 'success');
                } else {
                    showStatus('globalStatusContainer', `Token验证失败: ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('globalStatusContainer', `Token验证错误: ${error.message}`, 'error');
            }
        }
        
        // 退出登录
        async function logout() {
            const token = getAuthToken();
            
            if (!token) {
                showStatus('globalStatusContainer', '未登录', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/auth/logout`, {
                    headers: {
                        'token': token
                    }
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    currentUser = null;
                    setAuthToken('');
                    updateUserInfo();
                    showStatus('globalStatusContainer', '退出登录成功', 'success');
                } else {
                    showStatus('globalStatusContainer', `退出登录失败: ${data.message}`, 'error');
                }
            } catch (error) {
                showStatus('globalStatusContainer', `退出登录错误: ${error.message}`, 'error');
            }
        }
        
        // 分片文件
        function sliceFile(file, chunkSize) {
            const chunks = [];
            let start = 0;
            let index = 0;
            
            while (start < file.size) {
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);
                chunks.push({
                    chunk,
                    index,
                    start,
                    end,
                    size: end - start
                });
                start = end;
                index++;
            }
            
            return chunks;
        }
        
        // 上传单个分片
        async function uploadChunk(chunkData, uploadId, fileName, fileSize, chunkCount) {
            const formData = new FormData();
            formData.append('chunk', chunkData.chunk);
            formData.append('uploadId', uploadId);
            formData.append('chunkIndex', chunkData.index);
            
            const token = getAuthToken();
            const headers = {};
            if (token) {
                headers['token'] = token;
            }
            
            const response = await fetch(`${getApiBaseUrl()}/file/upload/chunk`, {
                method: 'POST',
                headers,
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`上传分片失败: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        // 初始化分片上传
        async function initChunkedUpload(fileName, fileSize, chunkCount) {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['token'] = token;
            }
            
            const response = await fetch(`${getApiBaseUrl()}/file/upload/chunk/init`, {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    fileName,
                    fileSize,
                    chunkCount
                })
            });
            
            if (!response.ok) {
                throw new Error(`初始化分片上传失败: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        // 合并分片
        async function mergeChunks(uploadId, fileName, fileSize, chunkCount) {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['token'] = token;
            }
            
            const description = document.getElementById('fileDescription').value;
            const isPublic = document.getElementById('isPublic').checked;
            
            const response = await fetch(`${getApiBaseUrl()}/file/upload/chunk/merge`, {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    uploadId,
                    fileName,
                    fileSize,
                    chunkCount,
                    description,
                    isPublic
                })
            });
            
            if (!response.ok) {
                throw new Error(`合并分片失败: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        // 上传单个文件
        async function uploadSingleFile(file, chunkSize) {
            showStatus('uploadStatusContainer', `正在处理文件: ${file.name}`, 'info');
            
            // 分片文件
            const chunks = sliceFile(file, chunkSize);
            showStatus('uploadStatusContainer', `文件已分割为 ${chunks.length} 个分片`, 'info');
            
            // 初始化分片上传
            const initResponse = await initChunkedUpload(
                file.name, file.size, chunks.length
            );
            
            if (initResponse.code !== 200) {
                throw new Error(`初始化分片上传失败: ${initResponse.message}`);
            }
            
            const uploadId = initResponse.data.uploadId;
            showStatus('uploadStatusContainer', `分片上传初始化成功，上传ID: ${uploadId}`, 'info');
            
            // 上传每个分片
            for (let i = 0; i < chunks.length; i++) {
                if (!isUploading) break;
                
                updateUploadProgress(
                    (i / chunks.length) * 100,
                    `正在上传分片 ${i + 1}/${chunks.length}`
                );
                
                try {
                    const chunkResponse = await uploadChunk(
                        chunks[i], uploadId, file.name, file.size, chunks.length
                    );
                    
                    if (chunkResponse.code !== 200) {
                        throw new Error(`上传分片失败: ${chunkResponse.message}`);
                    }
                    
                    showStatus('uploadStatusContainer', `分片 ${i + 1}/${chunks.length} 上传成功`, 'info');
                } catch (error) {
                    throw new Error(`上传分片 ${i + 1} 失败: ${error.message}`);
                }
            }
            
            // 更新进度到100%
            updateUploadProgress(100, `所有分片上传完成，正在合并...`);
            
            // 合并分片
            showStatus('uploadStatusContainer', '正在合并分片...', 'info');
            const mergeResponse = await mergeChunks(
                uploadId, file.name, file.size, chunks.length
            );
            
            if (mergeResponse.code !== 200) {
                throw new Error(`合并分片失败: ${mergeResponse.message}`);
            }
            
            return mergeResponse;
        }
        
        // 上传所有文件
        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const chunkSizeSelect = document.getElementById('uploadChunkSize');
            
            const files = fileInput.files;
            const chunkSize = parseInt(chunkSizeSelect.value) * 1024 * 1024; // 转换为字节
            
            if (files.length === 0) {
                showStatus('uploadStatusContainer', '请选择要上传的文件', 'error');
                return;
            }
            
            const token = getAuthToken();
            if (!token) {
                showStatus('uploadStatusContainer', '请先登录', 'error');
                return;
            }
            
            // 显示文件信息
            showFileInfo(Array.from(files));
            
            // 设置上传状态
            isUploading = true;
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('cancelUploadBtn').disabled = false;
            document.getElementById('uploadProgressContainer').style.display = 'block';
            
            try {
                uploadedFiles = [];
                
                for (let i = 0; i < files.length; i++) {
                    if (!isUploading) break;
                    
                    showStatus('uploadStatusContainer', `正在上传文件 ${i + 1}/${files.length}: ${files[i].name}`, 'info');
                    
                    const result = await uploadSingleFile(files[i], chunkSize);
                    uploadedFiles.push(result.data);
                    
                    showStatus('uploadStatusContainer', `文件 ${files[i].name} 上传成功`, 'success');
                }
                
                if (isUploading) {
                    showStatus('uploadStatusContainer', `所有文件上传完成！共上传 ${files.length} 个文件`, 'success');
                    updateUploadProgress(100, '上传完成');
                }
            } catch (error) {
                if (isUploading) {
                    showStatus('uploadStatusContainer', `上传失败: ${error.message}`, 'error');
                }
            } finally {
                isUploading = false;
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('cancelUploadBtn').disabled = true;
            }
        }
        
        // 取消上传
        function cancelUpload() {
            isUploading = false;
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('cancelUploadBtn').disabled = true;
            showStatus('uploadStatusContainer', '上传已取消', 'info');
        }
        
        // 刷新文件列表
        async function refreshFiles() {
            const token = getAuthToken();
            if (!token) {
                showStatus('globalStatusContainer', '请先登录', 'error');
                return;
            }
            
            try {
                // 这里需要根据实际API调整，暂时用一个模拟的文件列表
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = `
                    <div class="file-item">
                        <strong>示例文件1.txt</strong>
                        <button class="btn-secondary" onclick="downloadFile('file1')">下载</button>
                        <select class="permission-select" onchange="updatePermission('file1', this.value)">
                            <option value="owner">所有者</option>
                            <option value="editor">编辑者</option>
                            <option value="viewer">查看者</option>
                        </select>
                    </div>
                    <div class="file-item">
                        <strong>示例文件2.jpg</strong>
                        <button class="btn-secondary" onclick="downloadFile('file2')">下载</button>
                        <select class="permission-select" onchange="updatePermission('file2', this.value)">
                            <option value="owner">所有者</option>
                            <option value="editor">编辑者</option>
                            <option value="viewer" selected>查看者</option>
                        </select>
                    </div>
                `;
                
                showStatus('globalStatusContainer', '文件列表刷新成功', 'success');
            } catch (error) {
                showStatus('globalStatusContainer', `刷新文件列表失败: ${error.message}`, 'error');
            }
        }
        
        // 更新文件权限
        async function updatePermission(fileId, role) {
            const token = getAuthToken();
            const userId = document.getElementById('filePermissionUserId').value;
            
            if (!token) {
                showStatus('globalStatusContainer', '请先登录', 'error');
                return;
            }
            
            if (!userId) {
                showStatus('globalStatusContainer', '请输入用户ID', 'error');
                return;
            }
            
            // 这里需要根据实际API调整
            showStatus('globalStatusContainer', `文件 ${fileId} 权限已更新为 ${role}`, 'success');
        }
        
        // 通过文件ID下载（新流程）
        async function downloadFileById() {
            const fileId = document.getElementById('downloadFileId').value;
            const token = getAuthToken();

            if (!fileId) {
                showStatus('downloadStatusContainer', '请输入文件ID', 'error');
                return;
            }

            if (!token) {
                showStatus('downloadStatusContainer', '请先登录', 'error');
                return;
            }

            try {
                // 第一步：获取下载令牌
                showStatus('downloadStatusContainer', '正在获取下载令牌...', 'info');
                const tokenResponse = await fetch(`${getApiBaseUrl()}/file/download/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'token': token
                    },
                    body: JSON.stringify({
                        fileId: fileId
                    })
                });

                const tokenData = await tokenResponse.json();
                
                if (tokenData.code !== 200) {
                    throw new Error(`获取下载令牌失败: ${tokenData.message}`);
                }

                // 第二步：使用下载令牌下载文件
                showStatus('downloadStatusContainer', '正在下载文件...', 'info');
                const downloadUrl = `${getServerUrl()}${tokenData.data.downloadUrl}`;
                
                const response = await fetch(downloadUrl, {
                    method: 'GET'
                });

                if (!response.ok) {
                    if (response.status === 410) {
                        throw new Error('下载令牌已过期或已被使用，请重新获取');
                    } else if (response.status === 401) {
                        throw new Error('下载令牌无效或已过期');
                    } else if (response.status === 403) {
                        throw new Error('您没有权限下载此文件');
                    } else {
                        throw new Error(`下载失败: ${response.status} ${response.statusText}`);
                    }
                }

                // 转成 Blob
                const blob = await response.blob();

                // 从响应头里取文件名（如果后端有设置 Content-Disposition）
                let filename = `file_${fileId}`;
                const disposition = response.headers.get('Content-Disposition');
                if (disposition && disposition.includes('filename=')) {
                    filename = decodeURIComponent(
                        disposition.split('filename=')[1].replace(/["']/g, '')
                    );
                }

                // 创建临时下载链接
                const downloadLink = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadLink;
                link.download = filename;
                document.body.appendChild(link);
                link.click();

                // 清理
                document.body.removeChild(link);
                window.URL.revokeObjectURL(downloadLink);

                showStatus('downloadStatusContainer', '文件下载完成', 'success');
            } catch (error) {
                console.error(error);
                showStatus('downloadStatusContainer', `下载文件错误: ${error.message}`, 'error');
            }
        }
        
        // 页面加载完成后绑定事件
            document.addEventListener('DOMContentLoaded', function() {
                // 认证相关按钮
                document.getElementById('getCaptchaBtn').addEventListener('click', getCaptcha);
                document.getElementById('getEmailCodeBtn').addEventListener('click', function() {
                    const email = document.getElementById('regEmail').value;
                    if (!email) {
                        showGlobalStatus('请输入邮箱', 'error');
                        return;
                    }
                    getEmailCode(email, 'register');
                });
                document.getElementById('registerBtn').addEventListener('click', register);
                
                document.getElementById('getLoginCaptchaBtn').addEventListener('click', getCaptcha);
                document.getElementById('getLoginEmailCodeBtn').addEventListener('click', function() {
                    const email = document.getElementById('loginEmail').value;
                    if (!email) {
                        showGlobalStatus('请输入邮箱', 'error');
                        return;
                    }
                    getEmailCode(email, 'login');
                });
                document.getElementById('loginBtn').addEventListener('click', login);
                document.getElementById('verifyTokenBtn').addEventListener('click', verifyToken);
                document.getElementById('logoutBtn').addEventListener('click', logout);
                
                // 文件上传相关按钮
                document.getElementById('uploadBtn').addEventListener('click', uploadFiles);
                document.getElementById('cancelUploadBtn').addEventListener('click', cancelUpload);
                document.getElementById('fileInput').addEventListener('change', function(event) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        showFileInfo(Array.from(files));
                    } else {
                        document.getElementById('uploadFileInfoContainer').innerHTML = '';
                    }
                });
                
                // 文件管理相关按钮
                document.getElementById('refreshFilesBtn').addEventListener('click', refreshFiles);
                
                // 文件下载相关按钮
                document.getElementById('downloadByIdBtn').addEventListener('click', function() {
                    const fileId = document.getElementById('downloadFileId').value;
                    downloadFile(fileId);
                });
                
                // 初始化状态
                showGlobalStatus('欢迎使用Suiknit API测试平台', 'info');
            });
    </script>
</body>
</html>
